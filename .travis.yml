language: shell
dist: focal
os: linux
virt: vm
group: edge
arch:
- arm64-graviton2
- amd64

env:
  global:
before_install:
- openssl aes-256-cbc -K $encrypted_ddb265ce0382_key -iv $encrypted_ddb265ce0382_iv -in iotdevice-test-masahiro.login.enc -out iotdevice-test-masahiro.login -d
addons:
  snaps:
  - name: snapcraft
    channel: stable
    confinement: classic
  - name: lxd
    channel: stable

script:
- bash check_architecture.sh
- sudo usermod --append --groups lxd $USER
#- sudo /snap/bin/lxd waitready
#- sudo /snap/bin/lxd init --auto
#- sudo lxc list
#- sg lxd -c "snapcraft --use-lxd"
#- snapcraft --destructive-mode
#- echo " ----Deploy-----"
#- snapcraft login --with iotdevice-test-masahiro.login
#- snapcraft whoami
#- SNAP_NAME=("iotdevice-test-masahiro_0.1_$(cat arch).snap")
#- echo "snap name is $SNAP_NAME"
#- snapcraft push $SNAP_NAME
- snapcraft push *.snap

after_failure:
- sudo journalctl -u snapd
after_success:
 
deploy:
  provider: snap
  snap: *.snap
  channel: edge
  skip_cleanup: true

